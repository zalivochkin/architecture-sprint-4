Список логов с уровнем INFO:
Shop API:
- старт/стоп контейнера
- url, method, параметры запросов
- http статус, текст ошибки ответа на запрос
- результат загрузки 3D файла в S3
CRM API:
- старт/стоп контейнера
- url, method, параметры запросов
- http статус, текст ошибки ответа на запрос
- результат загрузки 3D файла в S3
- полученные сообщения из RabbitMQ
- отосланные сообщения в RabbitMQ
MES API:
- старт/стоп контейнера
- url, method, параметры запросов
- http статус, текст ошибки ответа на запрос
- результат получения 3D файла из S3
- полученные сообщения из RabbitMQ
- отосланные сообщения в RabbitMQ
Orders supervisor:
- старт/стоп контейнера
- запуск задачи проверки
- результат выполнения задачи проверки

Если API возвращает статус отличный от 200, но не 500 то делается запись с уровнем WARN
Если API возвращает статус 500 то делается запись с уровнем ERROR
Если контейнер аварийно завершает работу то делается запись с уровнем FATAL

Мотивация

Добавление логгирования преследует следующие цели:
1. Сократить временные затраты на диагностику
2. Решить проблему неполноты и неточности информации о ошибках
3. Снизить нагрузку на поддержку

Достижение этих целей приведёт к сокращению операционных расходов и улучшению качества обслуживания клиентов.
Анализ логов можно использовать для проактивного выявления проблем улучшения пользовательского опыта.
Так же наличие логов - это обязательное требование службы безопасности.

Технические метрики на которые повлияет добавление логгирования:
- MTTR - Mean Time To Recovery - так как наличие логов сильно сокращает время диагностики ошибки, то следовательно и время восстановления системы будет сокращаться
- MTBF - Mean Time Between Failures - анализ логов будет способствовать выявлению потенциальных проблем, что будет предотвращать инциденты и увеличивать время между сбоями
- Response Time - по данным из логов можно выявить узкие места в системе и произвести их оптимизацию, что приведёт к сокращению времени отклива
- Resource Utilization - логи помогут выявить какие ресурсы неэффективно используются и оптимизировать их потребление, а значит и сократить расходы

Бизнес метрики на которые повлияет добавление логгирования:
- количество обращений в поддержку - логи позволят операторам поддержки самостоятельно выявлять и решать проблемы до того, как клиены обнаружат наличие проблем
- удовлетворенность клиентов - снижение количества инцидентов и их быстрое разрешение приведет к повышению удовлетворенности клиентов

Предлагаемое решение

Для сбора, хранения и анализа логов необходимо внедрить стек ELK: jewerly_c4_model_v3.drawio
Политика безопасности в отношении логов полностью аналогична политике в отношении данных трейсига:
Для предотвращения несанкционированного доступа для компонента Kibana нужно добавить аутентификацию и авторизацию.
Доступ предоставить операторам, администраторам и разработчикам.
Передачу логов в Elasticsearch организовать так, что бы передавалась только минимально необходимая инфоормация (например только идентификатор заказа), а клиентская и финансовая информация в Elasticsearch не попадала.

Логи за последний месяц хранятся на основном инстансе Elasticsearch.
Более старые логи хранятся только для уровней Error и выше и располагаются вместе с основными бэкапами системы (на схеме не отображены).

Точно размер логов посчитать невозможно, так как недостаточно данных.
Если предположить, что на один заказ приходится 1 Мб логов и что в день в среднем 100 заказов, то для хранения логов за месяц потребуется 3 Гб памяти.

При появлении записи в логе уровня ERROR и выше необходимо отсылать сообщение разработчикам.
Для борьбы с DDoS атаками нужно настроить лимиты на количество запросов к API в единицу времени для пользователя: за секунду и за минуту.
Также есть смысл ограничить число активных заказов на одного пользователя - например 50 на физического и 500 на бизнес.
Если требуется больше, то заказы создавать через оператора.

Сравнение технологий для работы с логами
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
| Критерий               | ELK (Elasticsearch, Logstash, Kibana)                  | OpenSearch (OpenSearch, OpenSearch Dashboards)    | Splunk                                                      |
|------------------------|--------------------------------------------------------|---------------------------------------------------|-------------------------------------------------------------|
| Лицензия               | Elastic License                                        | Apache License, Version 2.0                       | Проприетарная                                               |
| Стоимость              | Бесплатная базовая версия, платные функции и поддержка | Бесплатная, открытая                              | Высокая, зависит от объема данных и функций                 |
| Производительность     | Высокая, масштабируемая                                | Высокая, масштабируемая                           | Высокая, оптимизирована для больших данных                  |
| Масштабируемость       | Горизонтальное масштабирование                         | Горизонтальное масштабирование                    | Горизонтальное и вертикальное масштабирование               |
| Надежность             | Высокая, репликация данных                             | Высокая, репликация данных                        | Высокая, отказоустойчивая архитектура                       |
| Простота установки     | Средняя, требуется настройка компонентов               | Средняя, требуется настройка компонентов          | Низкая, простая установка и настройка                       |
| Простота использования | Средняя, требуется изучение Kibana                     | Средняя, требуется изучение OpenSearch Dashboards | Высокая, интуитивно понятный интерфейс                      |
| Функциональность       | Широкая, поиск, анализ, визуализация                   | Широкая, поиск, анализ, визуализация              | Очень широкая, расширенные возможности анализа и отчетности |
| Поддержка              | Платная поддержка от Elastic                           | Поддержка сообщества, платные опции от AWS        | Платная поддержка от Splunk                                 |
| Безопасность           | Ролевая модель доступа, шифрование                     | Ролевая модель доступа, шифрование                | Ролевая модель доступа, шифрование, аудит                   |
| Облачная интеграция    | Elasticsearch Service (AWS, GCP, Azure)                | OpenSearch Service (AWS)                          | Splunk Cloud                                                |
| Сообщество             | Большое и активное                                     | Растущее, активное                                | Большое и активное                                          |
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
По удобству и простоте лучше всего выглядит Splunk.
Но его минусы - проприетарность и высокая стоимость перевешивают плюсы.
Из ELK и OpenSearch я выбрал ELK, как более зрелый и проверенный продукт, который продолжает активно развиваться и имеет обширную поддержку сообществом.
